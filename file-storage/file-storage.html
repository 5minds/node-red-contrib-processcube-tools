<script type="text/javascript">
    RED.nodes.registerType('file-storage', {
        category: 'ProcessCube Tools',
        color: '#02AFD6',
        defaults: {
            name: { value: '' },
            provider: { value: 'fs' },
            baseDir: { value: '' },
            usernameType: { value: 'str' },
            username: { value: '', required: true, validate: RED.validators.typedInput('usernameType') },
            passwordType: { value: 'str' },
            password: { value: '', required: true, validate: RED.validators.typedInput('passwordType') },
            hostType: { value: 'str' },
            host: { value: '', required: true, validate: RED.validators.typedInput('hostType') },
            portType: { value: 'str' },
            port: { value: '', required: true, validate: RED.validators.typedInput('portType') },
            databaseType: { value: 'str' },
            database: { value: '', required: true, validate: RED.validators.typedInput('databaseType') },
            
            pgSchema: { value: 'public' },
            pgTable: { value: 'files' },
            outputAs: { value: 'stream' },
            defaultAction: { value: 'store' },
        },
        inputs: 1,
        outputs: 1,
        icon: 'file.png',
        label: function () {
            return this.name || 'file-storage';
        },
        oneditprepare: function () {
            // postgres fields user, password, host, port, database
            $('#node-input-username').typedInput({
                default: 'str',
                types: ['str', 'env'],
                typeField: '#node-input-usernameType',
            });
            $('#node-input-password').typedInput({
                default: 'str',
                types: ['str', 'env'],
                typeField: '#node-input-passwordType',
            });
            $('#node-input-host').typedInput({
                default: 'str',
                types: ['str', 'env'],
                typeField: '#node-input-hostType',
            });
            $('#node-input-port').typedInput({
                default: 'str',
                types: ['str', 'env'],
                typeField: '#node-input-portType',
            });
            $('#node-input-database').typedInput({
                default: 'str',
                types: ['str', 'env'],
                typeField: '#node-input-databaseType',
            });
        },
    });
</script>

<script type="text/html" data-template-name="file-storage">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="file-storage" />
    </div>
    <div class="form-row">
        <label for="node-input-provider"><i class="fa fa-database"></i> Provider</label>
        <select id="node-input-provider">
            <option value="fs">Filesystem</option>
            <option value="pg">PostgreSQL</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-outputAs"><i class="fa fa-share-square-o"></i> Output</label>
        <select id="node-input-outputAs">
            <option value="stream">Stream</option>
            <option value="buffer">Buffer</option>
            <option value="path">Path (nur FS)</option>
        </select>
    </div>
    <hr />
    <div class="form-tips">Filesystem</div>
    <div class="form-row">
        <label for="node-input-baseDir"><i class="fa fa-folder-open"></i> Base Dir</label>
        <input type="text" id="node-input-baseDir" placeholder="/data/files" />
    </div>
    <hr />
    <div class="form-tips">PostgreSQL</div>
    <div class="form-row">
        <label for="node-input-username"><i class="fa fa-user"></i> Username</label>
        <input type="text" id="node-input-username" placeholder="postgres" />
        <input type="hidden" id="node-input-usernameType" />
    </div>
    <div class="form-row">
        <label for="node-input-password"><i class="fa fa-key"></i> Password</label>
        <input type="text" id="node-input-password" placeholder="postgres" />
         <input type="hidden" id="node-input-passwordType" />
    </div>
    <div class="form-row">
        <label for="node-input-host"><i class="fa fa-server"></i> Host</label>
        <input type="text" id="node-input-host" placeholder="localhost" />
         <input type="hidden" id="node-input-hostType" />
    </div>
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-plug"></i> Port</label>
        <input type="text" id="node-input-port" placeholder="5432" />
         <input type="hidden" id="node-input-portType" />
    </div>
    <div class="form-row">
        <label for="node-input-database"><i class="fa fa-database"></i> Database</label>
        <input type="text" id="node-input-database" placeholder="postgres" />
         <input type="hidden" id="node-input-databaseType" />
    </div>
    <div class="form-row">
        <label for="node-input-pgSchema"><i class="fa fa-sitemap"></i> Schema</label>
        <input type="text" id="node-input-pgSchema" placeholder="public" />
    </div>
    <div class="form-row">
        <label for="node-input-pgTable"><i class="fa fa-table"></i> Table</label>
        <input type="text" id="node-input-pgTable" placeholder="files" />
    </div>
    <hr />
    <div class="form-row">
        <label for="node-input-defaultAction"><i class="fa fa-cog"></i> Default Action</label>
        <select id="node-input-defaultAction">
            <option value="store">store</option>
            <option value="get">get</option>
            <option value="delete">delete</option>
        </select>
    </div>
</script>

<script type="text/html" data-help-name="file-storage">
    <h2>File Storage Node</h2>
    <p>
        The File Storage Node allows you to store, retrieve, and delete files (including metadata) using either the local filesystem or PostgreSQL (Large Objects + metadata table) as a backend.
    </p>
    <h3>Features</h3>
    <ul>
        <li><b>Providers:</b>
            <ul>
                <li>Filesystem (stores file and metadata as JSON)</li>
                <li>PostgreSQL (stores file as Large Object and metadata in a table)</li>
            </ul>
        </li>
        <li><b>Actions:</b> Store, Retrieve, Delete files</li>
        <li><b>Flexible output:</b> Stream, Buffer, or Path (filesystem only)</li>
    </ul>
    <h3>Node Properties</h3>
    <ul>
        <li><b>Name:</b> Optional node label.</li>
        <li><b>Provider:</b> Select between Filesystem and PostgreSQL.</li>
        <li><b>Output:</b> Choose the output type for retrieval: Stream, Buffer, or Path (Path only for filesystem).</li>
        <li><b>Base Dir:</b> (Filesystem) Directory where files are stored.</li>
        <li><b>PostgreSQL Connection:</b> Enter username, password, host, port, database, schema (default: public), and table (default: files).</li>
        <li><b>Default Action:</b> Default action if not specified in the message (store, get, or delete).</li>
    </ul>
    <h3>Input</h3>
    <pre>
msg.action = "store" | "get" | "delete" // Optional, overrides defaultAction
msg.payload = Buffer | ReadableStream | String // For "store"
msg.file = {
  id?: string,         // For "get" or "delete"
  filename?: string,   // For "store"
  contentType?: string,// For "store"
  metadata?: object    // For "store"
}
    </pre>
    <h3>Output</h3>
    <ul>
        <li><b>store:</b> <code>msg.payload</code> contains metadata including the generated <code>id</code>. <code>msg.file</code> contains the merged file info and result.</li>
        <li><b>get:</b> <code>msg.payload</code> contains the file as a Stream, Buffer, or Path (depending on output setting). <code>msg.file</code> contains the file metadata.</li>
        <li><b>delete:</b> <code>msg.payload</code> contains the result of the delete operation.</li>
    </ul>
    <h3>Example Usage</h3>
    <pre>
// Store a file:
msg.action = "store";
msg.payload = Buffer.from("Hello World");
msg.file = {
  filename: "hello.txt",
  contentType: "text/plain",
  metadata: { author: "Alice" }
};

// Retrieve a file:
msg.action = "get";
msg.file = { id: "your-file-id" };

// Delete a file:
msg.action = "delete";
msg.file = { id: "your-file-id" };
    </pre>
    <h3>Notes</h3>
    <ul>
        <li>For PostgreSQL, ensure the connection details (username, password, host, port, database, schema, table) are correct and the user has the necessary permissions.</li>
        <li>For filesystem storage, ensure the base directory is writable by Node-RED.</li>
        <li>The node is designed to handle large files efficiently using streams.</li>
        <li>If running in Docker, make sure the volumes are mapped correctly and the environment variables are set for both Node-RED and PostgreSQL services.</li>
    </ul>
    <p><b>Enjoy using the File Storage Node in your Node-RED flows!</b></p>
</script>
